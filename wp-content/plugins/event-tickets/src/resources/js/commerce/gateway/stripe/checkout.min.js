/**
 * This JS file was auto-generated via Terser.
 *
 * Contributors should avoid editing this file, but instead edit the associated
 * non minified file file. For more information, check out our engineering docs
 * on how we handle JS minification in our engineering docs.
 *
 * @see: https://evnt.is/dev-docs-minification
 */

tribe.tickets.commerce.gateway.stripe=tribe.tickets.commerce.gateway.stripe||{},tribe.tickets.commerce.gateway.stripe.checkout={},(($,obj,Stripe,ky)=>{"use strict";obj.checkout=tecTicketsCommerceGatewayStripeCheckout,obj.selectors={cardNumber:"#tec-tc-gateway-stripe-card-number",cardExpiry:"#tec-tc-gateway-stripe-card-expiry",cardCvc:"#tec-tc-gateway-stripe-card-cvc",cardZipWrapper:"#tec-tc-gateway-stripe-card-zip",cardElement:"#tec-tc-gateway-stripe-card-element",cardErrors:"#tec-tc-gateway-stripe-errors",paymentElement:"#tec-tc-gateway-stripe-payment-element",paymentMessage:"#tec-tc-gateway-stripe-payment-message",infoForm:".tribe-tickets__commerce-checkout-purchaser-info-wrapper",renderButton:"#tec-tc-gateway-stripe-render-payment",submitButton:"#tec-tc-gateway-stripe-checkout-button",hiddenElement:".tribe-common-a11y-hidden",form:".tribe-tickets__commerce-checkout-purchaser-info-wrapper__form"},obj.stripeLib=Stripe(obj.checkout.publishableKey),obj.stripeElements=null,obj.checkoutContainer=null,obj.handleErrorDisplay=(errors,afterDisplay=()=>{})=>{errors.map((e=>obj.showNotice({},"",e[1]))),afterDisplay()},obj.getRequestArgs=(data,headers)=>{void 0===headers&&(headers={"X-WP-Nonce":obj.checkout.nonce});const args={headers:headers,hooks:{beforeRetry:[obj.onBeforeRetry],beforeError:[obj.onBeforeError]},timeout:3e4,throwHttpErrors:!1};return data&&(args.json=data),args},obj.onBeforeRetry=async error=>(console.log(error),ky.stop),obj.onBeforeError=async error=>(console.log(error),ky.stop),obj.getWallets=()=>{const settings={applePay:"never",googlePay:"never"};if(!obj.checkout.wallet_settings)return settings;const wallet=obj.checkout.wallet_settings;return!0===wallet.apple_pay&&(settings.applePay="auto"),!0===wallet.google_pay&&(settings.googlePay="auto"),settings},obj.onCardChange=({error:error})=>{tribe.tickets.debug.log("stripe","cardChange",error);let displayError=$(obj.selectors.cardErrors);error?displayError.text(error.message):displayError.text("")},obj.submitButton=enable=>{$(obj.selectors.submitButton).prop("disabled",!enable)},obj.handleReceivePayment=async result=>(tribe.tickets.debug.log("stripe","handleReceivePayment",result),result.error?obj.handlePaymentError(result):"succeeded"===result.paymentIntent.status?obj.handlePaymentSuccess(result):void 0),obj.handlePaymentError=async data=>{if($(obj.selectors.cardErrors).val(data.error.message),tribe.tickets.debug.log("stripe","handlePaymentError",data),data.error.payment_intent){await obj.handleUpdateOrder(data.error.payment_intent)}return obj.handleErrorDisplay([[data.error.code,data.error.message]],(()=>{tribe.tickets.loader.hide(obj.checkoutContainer)}))},obj.handlePaymentSuccess=async data=>{tribe.tickets.debug.log("stripe","handlePaymentSuccess",data);const response=await obj.handleUpdateOrder(data.paymentIntent);return response.redirect_url&&URL.canParse(response.redirect_url)&&(window.location=response.redirect_url),!0},obj.handlePaymentDelayed=async data=>{tribe.tickets.debug.log("stripe","handlePaymentDelayed",data);const response=await obj.handleUpdateOrder(data.paymentIntent);return response.redirect_url&&URL.canParse(response.redirect_url)&&(window.location=response.redirect_url),!0},obj.handleUpdateOrder=async paymentIntent=>{const args=obj.getRequestArgs({client_secret:paymentIntent.client_secret});let response;try{response=await ky.post(`${obj.checkout.orderEndpoint}/${paymentIntent.id}`,args).json()}catch(error){response=error}return tribe.tickets.debug.log("stripe","updateOrder",response),response},obj.submitMultiPayment=async order=>0===$("#tec-tc-gateway-stripe-render-payment").length?obj.stripeLib.confirmPayment({elements:obj.stripeElements,redirect:"if_required",confirmParams:{return_url:order.return_url}}).then(obj.handleConfirmPayment):obj.stripeLib.confirmPayment({elements:obj.stripeElements,redirect:"if_required",confirmParams:{return_url:order.return_url,shipping:{name:obj.getPurchaserData().name,phone:obj.getPurchaserData().phone,address:{line1:$("#tec-tc-purchaser-address1").val(),line2:$("#tec-tc-purchaser-address2").val(),city:$("#tec-tc-purchaser-city").val(),state:$("#tec-tc-purchaser-state").val(),postal_code:$("#tec-tc-purchaser-zip").val(),country:$("#tec-tc-purchaser-country").val()}}}}).then(obj.handleConfirmPayment),obj.handleConfirmPayment=result=>(obj.submitButton(!0),result.error?obj.handlePaymentError(result):"succeeded"===result.paymentIntent.status?obj.handlePaymentSuccess(result):obj.handlePaymentDelayed(result)),obj.submitCardPayment=async()=>obj.stripeLib.confirmCardPayment(obj.checkout.paymentIntentData.key,{payment_method:{card:obj.cardElement}}).then(obj.handleConfirmCardPayment),obj.handleConfirmCardPayment=result=>{if(obj.submitButton(!0),!result.error)return"succeeded"===result.paymentIntent.status?obj.handlePaymentSuccess(result):obj.handlePaymentDelayed(result);obj.handlePaymentError(result)},obj.handleCreateOrder=async()=>{const args=obj.getRequestArgs({purchaser:obj.getPurchaserData(),payment_intent:obj.checkout.paymentIntentData});let response;try{response=await ky.post(obj.checkout.orderEndpoint,args).json()}catch(error){response=error}return tribe.tickets.debug.log("stripe","createOrder",response),response},obj.handlePayment=async event=>{event.preventDefault(),obj.checkoutContainer=$(event.target).closest(tribe.tickets.commerce.selectors.checkoutContainer),obj.hideNotice(obj.checkoutContainer),tribe.tickets.loader.show(obj.checkoutContainer);let order=await obj.handleCreateOrder();obj.submitButton(!1),order.success?obj.checkout.paymentElement?obj.submitMultiPayment(order):obj.submitCardPayment():(tribe.tickets.loader.hide(obj.checkoutContainer),obj.showNotice({},order.message,"")),obj.submitButton(!0)},obj.setupSeparateCardElement=()=>{obj.cardElement=obj.stripeElements.create("cardNumber",{showIcon:!0,iconStyle:"default",style:obj.checkout.cardElementStyle}),obj.cardElement.mount(obj.selectors.cardNumber),obj.cardElement.on("change",obj.onCardChange),obj.cardExpiry=obj.stripeElements.create("cardExpiry",{style:obj.checkout.cardElementStyle}),obj.cardExpiry.mount(obj.selectors.cardExpiry),obj.cardExpiry.on("change",obj.onCardChange),obj.cardCvc=obj.stripeElements.create("cardCvc",{style:obj.checkout.cardElementStyle}),obj.cardCvc.mount(obj.selectors.cardCvc),obj.cardCvc.on("change",obj.onCardChange)},obj.setupCompactCardElement=()=>{const options=obj.checkout.cardElementOptions;options.style||(options.style=obj.checkout.cardElementStyle),obj.cardElement=obj.stripeElements.create("card",options),obj.cardElement.mount(obj.selectors.cardElement),obj.cardElement.on("change",obj.onCardChange)},obj.setupPaymentElement=()=>{if(0===$("#tec-tc-gateway-stripe-render-payment").length){const walletSettings=obj.getWallets();obj.paymentElement=obj.stripeElements.create("payment",{fields:{name:"auto",email:"auto",phone:"auto",address:"auto"},wallets:walletSettings}),obj.paymentElement.mount(obj.selectors.paymentElement)}},obj.renderPayment=event=>{event.preventDefault();const form=$(obj.selectors.infoForm),fields=form.find("input, select");let valid=!0;if(fields.each(((index,field)=>{field.classList.remove("error"),field.nextElementSibling.classList.add(obj.selectors.hiddenElement.className()),field.required&&""===field.value&&(valid=!1,field.classList.add("error"),field.nextElementSibling.classList.remove(obj.selectors.hiddenElement.className()))})),!valid)return;$(obj.selectors.renderButton).addClass(obj.selectors.hiddenElement.className()),form.children("select, input").prop("disabled",!0),form.addClass("disabled");const walletSettings=obj.getWallets();obj.paymentElement=obj.stripeElements.create("payment",{defaultValues:{billingDetails:{name:$("#tec-tc-purchaser-name").val(),email:$("#tec-tc-purchaser-email").val(),phone:"",address:{line1:$("#tec-tc-purchaser-address1").val(),line2:$("#tec-tc-purchaser-address2").val(),city:$("#tec-tc-purchaser-city").val(),state:$("#tec-tc-purchaser-state").val(),country:$("#tec-tc-purchaser-country").val(),postal_code:$("#tec-tc-purchaser-zip").val()}},shippingDetails:{name:$("#tec-tc-purchaser-name").val(),email:$("#tec-tc-purchaser-email").val(),phone:"",address:{line1:$("#tec-tc-purchaser-address1").val(),line2:$("#tec-tc-purchaser-address2").val(),city:$("#tec-tc-purchaser-city").val(),state:$("#tec-tc-purchaser-state").val(),country:$("#tec-tc-purchaser-country").val(),postal_code:$("#tec-tc-purchaser-zip").val()}}},wallets:walletSettings}),obj.paymentElement.mount(obj.selectors.paymentElement),setTimeout((()=>{$(".tribe-tickets__commerce-checkout-gateways").get(0).scrollIntoView({behavior:"smooth"}),$(obj.selectors.submitButton).removeClass(obj.selectors.hiddenElement.className()),$(".tribe-tickets__commerce-checkout-section-header").removeClass(obj.selectors.hiddenElement.className())}),2e3)},obj.setupStripe=async()=>{if(0!==obj.checkout.paymentIntentData.length){if(obj.checkout.paymentIntentData.errors)return obj.submitButton(!1),$(obj.selectors.submitButton).addClass(obj.selectors.hiddenElement.className()),obj.handleErrorDisplay(obj.checkout.paymentIntentData.errors);obj.stripeElements=obj.stripeLib.elements({clientSecret:obj.checkout.paymentIntentData.key,appearance:obj.checkout.elementsAppearance}),obj.checkout.paymentElement?obj.setupPaymentElement():"separate"===obj.checkout.cardElementType?obj.setupSeparateCardElement():"compact"===obj.checkout.cardElementType&&obj.setupCompactCardElement()}},obj.getPurchaserData=()=>tribe.tickets.commerce.getPurchaserData($(tribe.tickets.commerce.selectors.purchaserFormContainer)),obj.showNotice=($container,title,content)=>{$container&&$container.length||($container=$(tribe.tickets.commerce.selectors.checkoutContainer));const notice=tribe.tickets.commerce.notice,$item=$container.find(notice.selectors.item);notice.populate($item,title,content),notice.show($item)},obj.hideNotice=$container=>{$container.length||($container=$(tribe.tickets.commerce.selectors.checkoutContainer));const notice=tribe.tickets.commerce.notice,$item=$container.find(notice.selectors.item);notice.hide($item)},obj.bindEvents=()=>{$(document).on("submit",obj.selectors.form,obj.renderPayment),$(document).on("click",obj.selectors.submitButton,obj.handlePayment)},obj.ready=()=>{obj.setupStripe(),obj.bindEvents()},$(obj.ready)})(jQuery,tribe.tickets.commerce.gateway.stripe,Stripe,tribe.ky);